#require "slu4-min64x4-asm >= 1.1.0"
#ifndef USE_ACCELERATOR
#print yellow "Compiling without USE_ACCELERATOR (software 16-bit core)"
#endif

; 64-bit Karatsuba vs schoolbook correctness tests.
; Compile with -D USE_ACCELERATOR to enable the hardware 16-bit core.

.memzone ZERO_PAGE_APPS
#mute
_test_index:        .byte 0
_compare_fail:      .byte 0
_a_base:            .2byte 0
_b_base:            .2byte 0
_expect_base:       .2byte 0
_a_ptr:             .2byte 0
_b_ptr:             .2byte 0
_expect_ptr:        .2byte 0
_actual_ptr:        .2byte 0
_cmp_expected_ptr:  .2byte 0
_cmp_actual_ptr:    .2byte 0
_cmp_count:         .byte 0
_print_ptr:         .2byte 0
_print_count:       .byte 0
_ptr_add_count:     .byte 0
#emit

.memzone ZERO_PAGE_LIBS
#mute
#emit

.memzone USER_APPS
main:
    SPINIT
    JPS _Clear
    MIZ 0,_XPos
    MIZ 0,_YPos
    JPS _Print "Karatsuba 64-bit tests\n"
    CLZ _test_index

    MIV test0_a,_a_base
    MIV test0_b,_b_base
    MIV test0_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test1_a,_a_base
    MIV test1_b,_b_base
    MIV test1_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test2_a,_a_base
    MIV test2_b,_b_base
    MIV test2_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test3_a,_a_base
    MIV test3_b,_b_base
    MIV test3_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test4_a,_a_base
    MIV test4_b,_b_base
    MIV test4_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test5_a,_a_base
    MIV test5_b,_b_base
    MIV test5_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test6_a,_a_base
    MIV test6_b,_b_base
    MIV test6_expect,_expect_base
    JPS run_test
    INZ _test_index

    MIV test7_a,_a_base
    MIV test7_b,_b_base
    MIV test7_expect,_expect_base
    JPS run_test

    JPS _Print "All tests passed\n"
    JPS _WaitInput
    JPS _Prompt

run_test:
    ; Schoolbook
    MVV _a_base,_a_ptr
    MVV _b_base,_b_ptr
    JPS run_sb
    MVV _expect_base,_expect_ptr
    JPS compare_expected
    CIZ 0,_compare_fail
    BNE sb_mismatch

    ; Karatsuba
    MVV _a_base,_a_ptr
    MVV _b_base,_b_ptr
    JPS run_ka
    MVV _expect_base,_expect_ptr
    JPS compare_expected
    CIZ 0,_compare_fail
    BNE ka_mismatch
    RTS

sb_mismatch:
    JPS _Print "SB mismatch in test "
    LDZ _test_index
    JAS _PrintHex
    JPS print_details
    JPS _WaitInput
    JPS _Prompt

ka_mismatch:
    JPS _Print "KA mismatch in test "
    LDZ _test_index
    JAS _PrintHex
    JPS print_details
    JPS _WaitInput
    JPS _Prompt

print_details:
    JPS _Print "\nA = "
    MVV _a_base,_print_ptr
    MIZ 7,_ptr_add_count
    JPS ptr_add
    MIZ 8,_print_count
    JPS print_bytes
    JPS _Print "\nB = "
    MVV _b_base,_print_ptr
    MIZ 7,_ptr_add_count
    JPS ptr_add
    MIZ 8,_print_count
    JPS print_bytes
    JPS _Print "\nExpected = "
    MVV _expect_base,_print_ptr
    MIZ 15,_ptr_add_count
    JPS ptr_add
    MIZ 16,_print_count
    JPS print_bytes
    JPS _Print "\nActual = "
    MIV actual_buf,_print_ptr
    MIZ 15,_ptr_add_count
    JPS ptr_add
    MIZ 16,_print_count
    JPS print_bytes
    JPS _Print "\n"
    RTS

ptr_add:
    CIZ 0,_ptr_add_count
    BEQ .done
.loop:
    INV _print_ptr
    DEZ _ptr_add_count
    BNE .loop
.done:
    RTS

print_bytes:
.loop:
    LDT _print_ptr
    JAS _PrintHex
    DEV _print_ptr
    DEZ _print_count
    BNE .loop
    RTS

run_sb:
    ; Push A (LSB -> MSB)
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr

    ; Push B (LSB -> MSB)
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr

    JPS sb64_unsigned_multiply

    MIV actual_buf,_actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    MIZ 16,_cmp_count
.pop_loop:
    PLS
    STT _actual_ptr
    DEV _actual_ptr
    DEZ _cmp_count
    BNE .pop_loop
    RTS

run_ka:
    ; Push A (LSB -> MSB)
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr
    LDT _a_ptr
    PHS
    INV _a_ptr

    ; Push B (LSB -> MSB)
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr
    LDT _b_ptr
    PHS
    INV _b_ptr

    JPS ka64_unsigned_multiply

    MIV actual_buf,_actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    INV _actual_ptr
    MIZ 16,_cmp_count
.pop_loop:
    PLS
    STT _actual_ptr
    DEV _actual_ptr
    DEZ _cmp_count
    BNE .pop_loop
    RTS

compare_expected:
    CLZ _compare_fail
    MVV _expect_ptr,_cmp_expected_ptr
    MIV actual_buf,_cmp_actual_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_expected_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    INV _cmp_actual_ptr
    MIZ 16,_cmp_count
.loop:
    LDT _cmp_expected_ptr
    CPR _cmp_actual_ptr
    BNE .mismatch
    DEV _cmp_expected_ptr
    DEV _cmp_actual_ptr
    DEZ _cmp_count
    BNE .loop
    RTS
.mismatch:
    INZ _compare_fail
    RTS

#include "karatsuba64_shared.min64x4"

actual_buf:
    .16byte 0

test0_a:
    .8byte 0x0000000000000000
test0_b:
    .8byte 0x123456789ABCDEF0
test0_expect:
    .16byte 0x00000000000000000000000000000000

test1_a:
    .8byte 0x0000000000000001
test1_b:
    .8byte 0xFFFFFFFFFFFFFFFF
test1_expect:
    .16byte 0x0000000000000000FFFFFFFFFFFFFFFF

test2_a:
    .8byte 0xFFFFFFFFFFFFFFFF
test2_b:
    .8byte 0xFFFFFFFFFFFFFFFF
test2_expect:
    .16byte 0xFFFFFFFFFFFFFFFE0000000000000001

test3_a:
    .8byte 0x00000000FFFFFFFF
test3_b:
    .8byte 0x00000000FFFFFFFF
test3_expect:
    .16byte 0x0000000000000000FFFFFFFE00000001

test4_a:
    .8byte 0xFFFFFFFF00000000
test4_b:
    .8byte 0x00000000FFFFFFFF
test4_expect:
    .16byte 0x00000000FFFFFFFE0000000100000000

test5_a:
    .8byte 0x8000000000000000
test5_b:
    .8byte 0x8000000000000000
test5_expect:
    .16byte 0x40000000000000000000000000000000

test6_a:
    .8byte 0x123456789ABCDEF0
test6_b:
    .8byte 0x0FEDCBA987654321
test6_expect:
    .16byte 0x0121FA00AD77D7422236D88FE5618CF0

test7_a:
    .8byte 0xFFFFFFFFFFFFFFFF
test7_b:
    .8byte 0x0000000100000001
test7_expect:
    .16byte 0x0000000100000000FFFFFFFEFFFFFFFF
